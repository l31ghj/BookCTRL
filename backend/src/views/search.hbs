
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>BookCTRL</title>
    <style>
      :root {
        --bg: #020617;
        --bg-elevated: #020617;
        --bg-soft: #020617;
        --border-subtle: #1f2937;
        --accent: #38bdf8;
        --accent-soft: rgba(56, 189, 248, 0.12);
        --accent-strong: #0ea5e9;
        --text-main: #e5e7eb;
        --text-muted: #9ca3af;
        --danger: #f97373;
      }
      * { box-sizing: border-box; }
      html, body { margin: 0; padding: 0; height: 100%; }
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background: radial-gradient(circle at top left, #0f172a 0, #020617 55%, #000 100%);
        color: var(--text-main);
      }
      a { color: inherit; text-decoration: none; }

      header {
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(18px);
        background: linear-gradient(to right, rgba(15,23,42,0.95), rgba(15,23,42,0.88));
        border-bottom: 1px solid rgba(30,64,175,0.6);
        padding: 0.75rem 2.25rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 0.6rem;
      }
      .brand-mark {
        width: 28px;
        height: 28px;
        border-radius: 999px;
        background: radial-gradient(circle at 30% 0, #e0f2fe 0, #38bdf8 30%, #0f172a 60%, #020617 100%);
        box-shadow: 0 0 0 1px rgba(56,189,248,0.5), 0 10px 30px rgba(15,23,42,0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        color: #0b1120;
      }
      .brand-text {
        display: flex;
        flex-direction: column;
      }
      .brand-text span:first-child {
        font-size: 0.8rem;
        letter-spacing: 0.18em;
        text-transform: uppercase;
        color: var(--text-muted);
      }
      .brand-text span:last-child {
        font-size: 0.9rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }

      nav {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        padding: 2px;
        border-radius: 999px;
        background: rgba(15,23,42,0.9);
        border: 1px solid rgba(55,65,81,0.9);
      }
      .nav-link {
        padding: 0.35rem 0.9rem;
        border-radius: 999px;
        font-size: 0.8rem;
        color: var(--text-muted);
        transition: background 0.16s, color 0.16s, transform 0.08s;
      }
      .nav-link:hover {
        color: var(--text-main);
        background: rgba(15,23,42,0.9);
        transform: translateY(-1px);
      }
      .nav-link.active {
        background: radial-gradient(circle at top left, var(--accent-soft), transparent 65%);
        color: var(--accent-strong);
        box-shadow: 0 0 0 1px rgba(56,189,248,0.35);
      }

      main {
        max-width: 1120px;
        margin: 1.5rem auto 3rem;
        padding: 0 1.5rem;
      }

      .page-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        gap: 1.5rem;
        margin-bottom: 1.25rem;
      }
      .page-title {
        font-size: 1.35rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }
      .page-subtitle {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-top: 0.35rem;
      }

      .pill {
        border-radius: 999px;
        padding: 0.25rem 0.85rem;
        font-size: 0.75rem;
        border: 1px solid rgba(55,65,81,0.9);
        color: var(--text-muted);
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .grid-cols-2 {
        display: grid;
        grid-template-columns: minmax(0, 2.2fr) minmax(0, 1.4fr);
        gap: 1.5rem;
      }
      @media (max-width: 900px) {
        header { padding-inline: 1rem; }
        main { padding-inline: 1rem; }
        .grid-cols-2 { grid-template-columns: minmax(0, 1fr); }
      }

      .card {
        background: radial-gradient(circle at top left, rgba(15,23,42,0.95), rgba(15,23,42,0.98));
        border-radius: 1rem;
        border: 1px solid rgba(31,41,55,0.95);
        box-shadow:
          0 22px 70px rgba(15,23,42,0.9),
          0 0 0 1px rgba(15,23,42,1);
        padding: 1.25rem 1.4rem;
      }
      .card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
      }
      .card-title {
        font-size: 0.95rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
      }
      .card-subtitle {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.15rem;
      }

      .search-row {
        display: flex;
        gap: 0.65rem;
        margin-top: 0.9rem;
      }
      .search-input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid rgba(55,65,81,0.9);
        background: radial-gradient(circle at top left, #020617, #020617);
        padding: 0.6rem 0.9rem;
        color: var(--text-main);
        font-size: 0.9rem;
      }
      .search-input::placeholder {
        color: rgba(148,163,184,0.8);
      }

      button {
        border-radius: 999px;
        border: none;
        padding: 0.5rem 1.1rem;
        font-size: 0.82rem;
        font-weight: 500;
        cursor: pointer;
        background: linear-gradient(135deg, #22c1c3, #0ea5e9);
        color: #0b1120;
        box-shadow: 0 10px 30px rgba(56,189,248,0.4);
        transition: transform 0.08s, box-shadow 0.12s, filter 0.09s;
      }
      button.secondary {
        background: radial-gradient(circle at top, #020617, #020617);
        color: var(--text-muted);
        box-shadow: none;
        border: 1px solid rgba(55,65,81,0.9);
      }
      button:hover {
        transform: translateY(-1px);
        filter: brightness(1.02);
      }
      button:active {
        transform: translateY(0);
        box-shadow: 0 4px 12px rgba(15,23,42,0.8);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 0.6rem;
      }
      th, td {
        padding: 0.4rem 0.3rem;
        font-size: 0.8rem;
        border-bottom: 1px solid rgba(31,41,55,0.9);
      }
      th {
        text-align: left;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        font-size: 0.74rem;
      }
      tr:last-child td {
        border-bottom: none;
      }

      .tag {
        display: inline-flex;
        align-items: center;
        padding: 0.15rem 0.55rem;
        border-radius: 999px;
        border: 1px solid rgba(55,65,81,0.9);
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-right: 0.25rem;
      }
      .badge {
        display: inline-flex;
        align-items: center;
        padding: 0.1rem 0.6rem;
        border-radius: 999px;
        border: 1px solid rgba(55,65,81,0.9);
        font-size: 0.73rem;
        color: var(--text-muted);
      }
      .badge--source {
        border-color: rgba(56,189,248,0.45);
        color: var(--accent-strong);
      }
      .text-muted { color: var(--text-muted); font-size: 0.8rem; }
      .text-xs { font-size: 0.75rem; }
      .mt-1 { margin-top: 0.25rem; }
      .mt-2 { margin-top: 0.5rem; }
      .mt-3 { margin-top: 0.75rem; }
      .download-cell {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
      }
      .progress {
        position: relative;
        width: 100%;
        height: 6px;
        border-radius: 999px;
        background: rgba(55,65,81,0.7);
        overflow: hidden;
      }
      .progress-bar {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        width: 0%;
        background: linear-gradient(135deg, #22c1c3, #0ea5e9);
        transition: width 0.12s ease-out;
      }
      .toast {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(15,23,42,0.95);
        color: var(--text-main);
        padding: 0.75rem 1rem;
        border-radius: 10px;
        border: 1px solid rgba(56,189,248,0.4);
        box-shadow: 0 18px 50px rgba(0,0,0,0.35);
        opacity: 0;
        transform: translateY(8px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
        font-size: 0.9rem;
      }
      .toast.show {
        opacity: 1;
        transform: translateY(0);
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="brand-mark">BC</div>
        <div class="brand-text">
          <span>LIBRARY</span>
          <span>BOOKCTRL</span>
        </div>
      </div>
      <nav>
        <a href="/search" class="nav-link{{#if isSearch}} active{{/if}}">Search</a>
        <a href="/library" class="nav-link{{#if isLibrary}} active{{/if}}">Library</a>
        <a href="/settings/providers" class="nav-link{{#if isProviders}} active{{/if}}">Providers</a>
      </nav>
    </header>
    <main>

      <div class="page-header">
        <div>
          <div class="page-title">Search</div>
          <p class="page-subtitle">
            Search your connected providers and download titles straight into your library.
          </p>
        </div>
        <div class="pill">
          <span class="text-xs">BookCTRL</span>
          <span class="text-xs" style="opacity:.7">Providers</span>
        </div>
      </div>

      <div class="grid-cols-2">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Query</div>
              <div class="card-subtitle">Type a title or author to get started.</div>
            </div>
          </div>
          <form method="GET" action="/search">
            <div class="search-row">
              <input
                class="search-input"
                type="text"
                name="q"
                placeholder="Search &mdash; e.g. &quot;Pride and Prejudice&quot;"
                value="{{query}}"
              />
              <button type="submit">Search</button>
            </div>
          </form>

          {{#if query}}
          <div class="mt-3">
            {{#if results.length}}
            <table>
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Author</th>
                  <th>Provider</th>
                  <th>Formats</th>
                </tr>
              </thead>
              <tbody>
                {{#each results}}
                <tr>
                  <td>
                    <div>{{title}}</div>
                    {{#if description}}
                      <div class="text-xs text-muted">{{description}}</div>
                    {{/if}}
                  </td>
                  <td>{{author}}</td>
                  <td>
                    <span class="badge badge--source">{{providerName}}</span>
                    <div class="text-xs text-muted">{{providerType}}</div>
                  </td>
                  <td>
                    <div class="download-cell">
                      {{#if formats.length}}
                        {{#each formats}}
                        <form method="POST" action="/search/download" class="download-form" data-title="{{../title}}">
                          <input type="hidden" name="query" value="{{../../query}}">
                          <input type="hidden" name="title" value="{{../title}}">
                          <input type="hidden" name="author" value="{{../author}}">
                          <input type="hidden" name="providerType" value="{{../providerType}}">
                          <input type="hidden" name="providerBookId" value="{{../providerBookId}}">
                          <input type="hidden" name="format" value="{{format}}">
                          <input type="hidden" name="url" value="{{url}}">
                          <button type="submit" class="secondary">
                            Get {{format}}
                            {{#if sizeLabel}} ({{sizeLabel}}){{/if}}
                          </button>
                          <div class="progress" aria-hidden="true">
                            <div class="progress-bar"></div>
                          </div>
                        </form>
                        {{/each}}
                      {{else}}
                        <span class="text-muted text-xs">No download formats</span>
                      {{/if}}
                    </div>
                  </td>
                </tr>
                {{/each}}
              </tbody>
            </table>
            {{else}}
            <p class="text-muted mt-2">No results yet. Check provider settings or try a different query.</p>
            {{/if}}
          </div>
          {{/if}}
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Status</div>
              <div class="card-subtitle">
                {{#if providers.length}}
                  {{providers.length}} provider(s) connected.
                {{else}}
                  Add a provider to enable search.
                {{/if}}
              </div>
            </div>
          </div>
          {{#if providers.length}}
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              {{#each providers}}
              <tr>
                <td>{{name}}</td>
                <td><span class="badge badge--source">{{type}}</span></td>
                <td>{{#if isEnabled}}Enabled{{else}}Disabled{{/if}}</td>
              </tr>
              {{/each}}
            </tbody>
          </table>
          {{else}}
          <p class="text-muted">
            No providers configured yet. Head to Providers to add Gutenberg or other sources.
          </p>
          {{/if}}
        </section>
      </div>

    </main>
    <div class="toast" id="toast"></div>

    <script>
      const toast = document.getElementById('toast');
      function showToast(message) {
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3200);
      }

      function startFakeProgress(bar) {
        let progress = 10;
        bar.style.width = progress + '%';
        const id = setInterval(() => {
          progress = Math.min(progress + Math.random() * 10, 90);
          bar.style.width = progress + '%';
        }, 250);
        return () => {
          clearInterval(id);
          bar.style.width = '100%';
          setTimeout(() => { bar.style.width = '0%'; }, 800);
        };
      }

      document.querySelectorAll('.download-form').forEach((form) => {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          const button = form.querySelector('button');
          const bar = form.querySelector('.progress-bar');
          button.disabled = true;
          button.textContent = 'Downloading...';
          const stop = startFakeProgress(bar);

          try {
            const data = new FormData(form);
            const payload = Object.fromEntries(data.entries());
            const res = await fetch(form.action, {
              method: 'POST',
              headers: {
                Accept: 'application/json',
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            });
            const json = await res.json().catch(() => null);
            if (!res.ok) throw new Error((json && json.error) || 'Download failed');
            stop();
            button.textContent = 'Downloaded';
            showToast(`Downloaded: ${form.dataset.title}`);
          } catch (err) {
            stop();
            button.textContent = 'Get failed';
            button.classList.remove('secondary');
            button.style.background = '#f97373';
            showToast(err?.message || 'Download failed. Please retry.');
          } finally {
            setTimeout(() => {
              button.disabled = false;
              button.textContent = 'Get ' + (form.querySelector('input[name="format"]').value || '');
              button.classList.add('secondary');
              button.style.background = '';
            }, 1200);
          }
        });
      });
    </script>
  </body>
</html>
